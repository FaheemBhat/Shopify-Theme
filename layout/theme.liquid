<!doctype html>
<html lang="{{ request.locale.iso_code }}">
  <head>
    {% # Inlined CSS Variables %}
    {% render 'css-variables' %}

    {% # Dark mode overrides %}
    {% render 'dark-mode' %}

    {% # Apply stored theme preference BEFORE paint to prevent flash %}
    <script>
    (function(){
      var t = localStorage.getItem('theme-preference');
      if (!t) t = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', t);
    })();
    </script>

    {% comment %}
      Font preloading:
      1. Preconnect to font CDN for faster connection
      2. Preload only the critical font variant (base weight)
      3. Additional variants load on-demand via @font-face
    {% endcomment %}
    {% unless settings.type_primary_font.system? %}
      <link rel="preconnect" href="https://fonts.shopifycdn.com" crossorigin>
      {{ settings.type_primary_font | font_url | preload_tag: as: 'font', crossorigin: 'anonymous' }}
    {% endunless %}

    {% unless settings.type_heading_font.system? %}
      {% if settings.type_primary_font.system? %}
        <link rel="preconnect" href="https://fonts.shopifycdn.com" crossorigin>
      {% endif %}
      {{ settings.type_heading_font | font_url | preload_tag: as: 'font', crossorigin: 'anonymous' }}
    {% endunless %}

    {% # Load and preload the critical CSS %}
    {{ 'critical.css' | asset_url | stylesheet_tag: preload: true }}

    {% # Prevent FOUC — hide body until styles are parsed %}
    <style>body { opacity: 0; }</style>

    {% # Favicon %}
    {% if settings.favicon %}
      <link rel="icon" type="image/png" href="{{ settings.favicon | image_url: width: 32, height: 32 }}">
    {% endif %}

    {% # Social, title, etc. %}
    {% render 'meta-tags' %}

    {{ content_for_header }}
  </head>

  <body class="color-scheme-1">
    <script>
    (function(){
      var t = document.documentElement.getAttribute('data-theme') || 'light';
      document.body.setAttribute('data-theme', t);
      if (t === 'dark') { document.body.classList.remove('color-scheme-1'); document.body.classList.add('color-scheme-2'); }
    })();
    </script>
    {% sections 'header-group' %}

    {{ content_for_layout }}

    {% sections 'footer-group' %}

    {% sections 'overlay-group' %}

    {% # Reveal body after all section CSS has loaded %}
    <style>body { opacity: 1; transition: opacity 0.15s ease; }</style>

    {% # Predictive search %}
    <script>
    document.addEventListener("DOMContentLoaded", () => {
      const input = document.getElementById("HeaderSearchInput");
      const results = document.getElementById("PredictiveResults");
      const recentBox = document.getElementById("RecentSearches");
      if (!input || !results || !recentBox) return;

      let controller;

      function highlight(text, query) {
        const reg = new RegExp(`(${query})`, "gi");
        return text.replace(reg, '<span class="highlight">$1</span>');
      }

      function showSkeleton() {
        results.innerHTML = `
          <div class="skeleton">
            <div class="skeleton-img"></div>
            <div class="skeleton-lines">
              <span></span><span></span>
            </div>
          </div>
          <div class="skeleton">
            <div class="skeleton-img"></div>
            <div class="skeleton-lines">
              <span></span><span></span>
            </div>
          </div>
        `;
        results.style.display = "block";
      }

      function saveRecent(query) {
        let searches = JSON.parse(localStorage.getItem("recent_searches") || "[]");
        searches = searches.filter(s => s !== query);
        searches.unshift(query);
        localStorage.setItem("recent_searches", JSON.stringify(searches.slice(0,5)));
      }

      function showRecent() {
        const searches = JSON.parse(localStorage.getItem("recent_searches") || "[]");
        if (!searches.length) return;

        recentBox.innerHTML = searches.map(s => `<div>${s}</div>`).join("");
        recentBox.style.display = "block";
      }

      input.addEventListener("focus", showRecent);

      recentBox.addEventListener("click", e => {
        input.value = e.target.innerText;
        input.dispatchEvent(new Event("input"));
        recentBox.style.display = "none";
      });

      input.addEventListener("input", async () => {
        const query = input.value.trim();
        recentBox.style.display = "none";

        if (query.length < 2) {
          results.style.display = "none";
          return;
        }

        showSkeleton();

        if (controller) controller.abort();
        controller = new AbortController();

        const res = await fetch(`/search/suggest.json?q=${query}&resources[type]=product&resources[limit]=6`);
        const data = await res.json();
        const products = data.resources.results.products;

        saveRecent(query);

        if (!products.length) {
          results.innerHTML = `<div class="no-results">No results found for "${query}"</div>`;
          return;
        }

        results.innerHTML = products.map(p => `
          <a href="${p.url}" class="search-item">
            <img src="${p.featured_image.url}">
            <div>
              <div class="search-title">${highlight(p.title, query)}</div>
              <div class="search-price">₹${(p.price/100).toFixed(2)}</div>
            </div>
          </a>
        `).join("") + `<a class="view-all" href="/search?q=${query}&type=product">View all results →</a>`;

      });

      document.addEventListener("click", e => {
        if (!e.target.closest(".header__search")) {
          results.style.display = "none";
          recentBox.style.display = "none";
        }
      });
    });
    </script>
  </body>
</html>
