{% comment %}
  Shop The Banner Section - Full-width banner with product slider overlay
{% endcomment %}

<section class="shop-banner-section" data-section-id="{{ section.id }}">
  <div class="shop-banner-container">

    {%- comment -%} Full-width Banner Background {%- endcomment -%}
    <div class="shop-banner-bg">
      {%- assign mobile_img = section.settings.mobile_banner_image | default: section.settings.banner_image -%}

      {% if section.settings.banner_image != blank %}
        <img
          src="{{ section.settings.banner_image | image_url: width: 1920 }}"
          alt="{{ section.settings.banner_image.alt | default: section.settings.banner_alt | escape }}"
          class="banner-img banner-img--desktop"
          loading="lazy"
          width="1920"
          height="1080"
        >
      {% endif %}

      {% if mobile_img != blank %}
        <img
          src="{{ mobile_img | image_url: width: 800 }}"
          alt="{{ mobile_img.alt | default: section.settings.banner_alt | escape }}"
          class="banner-img banner-img--mobile"
          loading="lazy"
          width="800"
          height="1000"
        >
      {% endif %}

      {% if section.settings.banner_image == blank and mobile_img == blank %}
        <div class="banner-placeholder">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
            <circle cx="8.5" cy="8.5" r="1.5"/>
            <polyline points="21,15 16,10 5,21"/>
          </svg>
          <span>Upload Banner Image</span>
        </div>
      {% endif %}

      {% if section.settings.banner_link != blank %}
        <a href="{{ section.settings.banner_link }}" class="banner-link" aria-label="{{ section.settings.banner_alt | escape }}"></a>
      {% endif %}
    </div>

    {%- comment -%} Product Slider Overlay {%- endcomment -%}
    <div class="shop-banner-products">

      {% if section.settings.show_shop_all and section.settings.collection != blank %}
        <div class="products-header">
          <a href="{{ section.settings.collection.url }}" class="shop-all-btn">
            SHOP ALL
          </a>
        </div>
      {% endif %}

      {% if section.settings.collection != blank %}
        <div class="products-slider-wrapper">
          <button type="button" class="slider-nav slider-prev" aria-label="Previous products">
            &#8249;
          </button>

          <div class="products-slider" data-slides-to-show="{{ section.settings.slides_desktop }}">
            <div class="slider-track">
              {% for product in section.settings.collection.products limit: section.settings.products_limit %}
                <div class="slider-slide">
                  <div class="product-slide-card">
                    <a href="{{ product.url }}" class="slide-image-link">
                      <div class="slide-image-wrapper">
                        {% if product.featured_image != blank %}
                          <img
                            src="{{ product.featured_image | image_url: width: 500 }}"
                            alt="{{ product.featured_image.alt | escape }}"
                            class="slide-product-image"
                            loading="lazy"
                            width="500"
                            height="667"
                          >
                        {% else %}
                          {{ 'product-1' | placeholder_svg_tag: 'slide-product-image placeholder-svg' }}
                        {% endif %}
                      </div>
                    </a>
                    <div class="slide-card-actions">
                      {% form 'product', product, class: 'slide-product-form' %}
                        <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
                        <input type="hidden" name="quantity" value="1">
                        <button
                          type="submit"
                          name="add"
                          class="slide-add-to-cart"
                          {% unless product.available %}disabled{% endunless %}
                        >
                          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                            <circle cx="9" cy="21" r="1"/>
                            <circle cx="20" cy="21" r="1"/>
                            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
                          </svg>
                          {% if product.available %}
                            {{ section.settings.cart_button_text }}
                          {% else %}
                            {{ section.settings.sold_out_text }}
                          {% endif %}
                        </button>
                      {% endform %}
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>

          <button type="button" class="slider-nav slider-next" aria-label="Next products">
            &#8250;
          </button>
        </div>
      {% else %}
        <div class="no-collection-message">
          <p>Select a collection in the theme editor to display products.</p>
        </div>
      {% endif %}
    </div>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const section = document.querySelector('[data-section-id="{{ section.id }}"]');
    if (!section) return;
    
    const slider = section.querySelector('.products-slider');
    const track = section.querySelector('.slider-track');
    const slides = section.querySelectorAll('.slider-slide');
    const prevBtn = section.querySelector('.slider-prev');
    const nextBtn = section.querySelector('.slider-next');
    
    if (!slider || !track || slides.length === 0) return;
    
    let currentIndex = 0;
    let slidesToShow = parseInt(slider.dataset.slidesToShow) || 3;
    let slideWidth = 0;
    let maxIndex = 0;
    
    function calculateDimensions() {
      const sliderWidth = slider.offsetWidth;
      const gap = 16;
      
      // Responsive slides to show
      if (window.innerWidth <= 480) {
        slidesToShow = 1;
      } else if (window.innerWidth <= 768) {
        slidesToShow = 2;
      } else {
        slidesToShow = parseInt(slider.dataset.slidesToShow) || 3;
      }
      
      slideWidth = (sliderWidth - (gap * (slidesToShow - 1))) / slidesToShow;
      maxIndex = Math.max(0, slides.length - slidesToShow);
      
      slides.forEach(slide => {
        slide.style.minWidth = slideWidth + 'px';
        slide.style.maxWidth = slideWidth + 'px';
      });
      
      updateSlider(false);
      updateNavButtons();
    }
    
    function updateSlider(animate = true) {
      const gap = 16;
      const translateX = currentIndex * (slideWidth + gap);
      track.style.transition = animate ? 'transform 0.4s ease' : 'none';
      track.style.transform = `translateX(-${translateX}px)`;
    }
    
    function updateNavButtons() {
      if (prevBtn) {
        prevBtn.style.opacity = currentIndex === 0 ? '0.3' : '1';
        prevBtn.style.pointerEvents = currentIndex === 0 ? 'none' : 'auto';
      }
      if (nextBtn) {
        nextBtn.style.opacity = currentIndex >= maxIndex ? '0.3' : '1';
        nextBtn.style.pointerEvents = currentIndex >= maxIndex ? 'none' : 'auto';
      }
    }
    
    function goToSlide(index) {
      currentIndex = Math.max(0, Math.min(index, maxIndex));
      updateSlider();
      updateNavButtons();
    }
    
    if (prevBtn) {
      prevBtn.addEventListener('click', () => goToSlide(currentIndex - 1));
    }
    
    if (nextBtn) {
      nextBtn.addEventListener('click', () => goToSlide(currentIndex + 1));
    }
    
    // Touch/Swipe support
    let touchStartX = 0;
    let touchEndX = 0;
    
    slider.addEventListener('touchstart', (e) => {
      touchStartX = e.changedTouches[0].screenX;
    }, { passive: true });
    
    slider.addEventListener('touchend', (e) => {
      touchEndX = e.changedTouches[0].screenX;
      const diff = touchStartX - touchEndX;
      if (Math.abs(diff) > 50) {
        if (diff > 0) {
          goToSlide(currentIndex + 1);
        } else {
          goToSlide(currentIndex - 1);
        }
      }
    }, { passive: true });
    
    // Mouse drag support (desktop)
    let isDragging = false;
    let dragStartX = 0;
    let dragStartTranslate = 0;
    let dragDelta = 0;

    slider.addEventListener('mousedown', function(e) {
      isDragging = true;
      dragStartX = e.clientX;
      dragDelta = 0;
      const gap = 16;
      dragStartTranslate = currentIndex * (slideWidth + gap);
      track.style.transition = 'none';
      slider.style.cursor = 'grabbing';
      e.preventDefault();
    });

    document.addEventListener('mousemove', function(e) {
      if (!isDragging) return;
      dragDelta = dragStartX - e.clientX;
      var newTranslate = dragStartTranslate + dragDelta;
      track.style.transform = 'translateX(-' + newTranslate + 'px)';
    });

    document.addEventListener('mouseup', function() {
      if (!isDragging) return;
      isDragging = false;
      slider.style.cursor = 'grab';
      if (Math.abs(dragDelta) > 50) {
        if (dragDelta > 0) {
          goToSlide(currentIndex + 1);
        } else {
          goToSlide(currentIndex - 1);
        }
      } else {
        updateSlider();
      }
    });

    slider.style.cursor = 'grab';

    // Prevent click after drag
    slider.addEventListener('click', function(e) {
      if (Math.abs(dragDelta) > 5) {
        e.preventDefault();
        e.stopPropagation();
      }
    }, true);

    // Initialize
    calculateDimensions();
    
    // Recalculate on resize
    let resizeTimer;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(calculateDimensions, 100);
    });
  });
</script>

<style>
  .shop-banner-section {
    --section-height: {{ section.settings.section_height }}px;
    --shop-all-color: {{ section.settings.shop_all_color }};
    --nav-color: {{ section.settings.nav_color }};
  }

  .shop-banner-container {
    position: relative;
    width: 100%;
    height: var(--section-height);
    overflow: hidden;
  }

  /* Full-width Banner Background */
  .shop-banner-bg {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 0;
  }

  .banner-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
    display: block;
  }

  .banner-img--mobile {
    display: none;
  }

  .banner-link {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1;
  }

  .banner-placeholder {
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 16px;
    color: #666;
  }

  .banner-placeholder svg {
    width: 60px;
    height: 60px;
    opacity: 0.5;
  }

  .banner-placeholder span {
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }

  /* Products Overlay */
  .shop-banner-products {
    position: absolute;
    top: 0;
    right: 0;
    width: {{ section.settings.products_width }}%;
    height: 100%;
    display: flex;
    flex-direction: column;
    padding: 30px;
    z-index: 2;
  }

  /* Header */
  .products-header {
    display: flex;
    justify-content: flex-end;
    margin-bottom: 24px;
  }

  .shop-all-btn {
    font-size: 12px;
    font-weight: 600;
    color: {{ section.settings.shop_all_color }};
    text-decoration: none;
    letter-spacing: 0.15em;
    padding: 10px 0;
    position: relative;
    transition: opacity 0.3s ease;
    white-space: nowrap;
  }

  .shop-all-btn::after {
    content: '';
    position: absolute;
    bottom: 8px;
    left: 0;
    width: 100%;
    height: 1px;
    background: {{ section.settings.shop_all_color }};
    transform: scaleX(0);
    transform-origin: right;
    transition: transform 0.3s ease;
  }

  .shop-all-btn:hover::after {
    transform: scaleX(1);
    transform-origin: left;
  }

  /* Slider */
  .products-slider-wrapper {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 12px;
    position: relative;
    min-height: 0;
  }

  .slider-nav {
    background: none;
    border: none;
    cursor: pointer;
    color: var(--nav-color);
    font-size: 36px;
    line-height: 1;
    padding: 0;
    flex-shrink: 0;
    transition: opacity 0.3s ease;
    z-index: 2;
    user-select: none;
  }

  .slider-nav:hover {
    opacity: 0.6;
  }

  .products-slider {
    flex: 1;
    overflow: hidden;
    min-width: 0;
  }

  .slider-track {
    display: flex;
    gap: 16px;
    will-change: transform;
  }

  .slider-slide {
    flex-shrink: 0;
  }

  .product-slide-card {
    display: flex;
    flex-direction: column;
    height: 100%;
    position: relative;
  }

  .slide-image-link {
    display: block;
    text-decoration: none;
  }

  .slide-image-wrapper {
    width: 100%;
    aspect-ratio: 3/4;
    overflow: hidden;
    border-radius: 4px;
    background: rgba(255, 255, 255, 1);
    position: relative;
  }

  .slide-product-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s ease, opacity 0.3s ease;
  }

  .slide-image-link:hover .slide-product-image {
    transform: scale(1.08);
  }

  /* Add to Cart */
  .slide-card-actions {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    padding: 10px;
    z-index: 3;
  }

  .slide-product-form {
    width: 100%;
  }

  .slide-add-to-cart {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 10px 12px;
    background: {{ section.settings.cart_button_bg }};
    color: white;
    border:none;
    border-radius:8px;
  }


  .slide-add-to-cart:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .slide-add-to-cart svg {
    flex-shrink: 0;
  }

  .placeholder-svg {
    width: 100%;
    height: 100%;
    padding: 20%;
    opacity: 0.3;
  }

  /* No Collection Message */
  .no-collection-message {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    color: rgba(255, 255, 255, 0.5);
    font-size: 14px;
    text-align: center;
  }

  /* Responsive */
  @media screen and (max-width: 992px) {
    .shop-banner-products {
      padding: 24px;
    }
  }

  @media screen and (max-width: 768px) {
    .shop-banner-container {
      height: auto;
      display: flex;
      flex-direction: column;
    }

    .shop-banner-bg {
      position: relative;
      height: auto;
    }

    .banner-img--desktop {
      display: none;
    }

    .banner-img--mobile {
      display: block;
      height: auto;
    }

    .shop-banner-products {
      position: relative;
      width: 100%;
      height: auto;
      padding: 24px 20px;
      background: {{ section.settings.mobile_slider_bg }};
    }

    .products-header {
      margin-bottom: 20px;
    }

    .slider-nav {
      font-size: 30px;
    }
  }

  @media screen and (max-width: 480px) {
    .shop-banner-products {
      padding: 20px 16px;
    }

    .shop-all-btn {
      font-size: 11px;
    }

    .products-slider-wrapper {
      gap: 8px;
    }

    .slider-nav {
      font-size: 26px;
    }

    .slider-track {
      gap: 12px;
    }

    .slide-card-actions {
      padding: 8px;
    }

    .slide-add-to-cart {
      padding: 8px 10px;
      font-size: 10px;
      gap: 6px;
    }

    .slide-add-to-cart svg {
      width: 14px;
      height: 14px;
    }
  }
</style>

{% schema %}
{
  "name": "Shop The Banner",
  "tag": "section",
  "class": "shop-banner-wrapper",
  "settings": [
    {
      "type": "header",
      "content": "Banner Settings"
    },
    {
      "type": "image_picker",
      "id": "banner_image",
      "label": "Banner Image"
    },
    {
      "type": "text",
      "id": "banner_alt",
      "label": "Banner Alt Text",
      "default": "Shop the collection"
    },
    {
      "type": "image_picker",
      "id": "mobile_banner_image",
      "label": "Mobile Banner Image",
      "info": "Optional. Falls back to desktop banner if not set."
    },
    {
      "type": "url",
      "id": "banner_link",
      "label": "Banner Link"
    },
    {
      "type": "header",
      "content": "Collection Settings"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection"
    },
    {
      "type": "range",
      "id": "products_limit",
      "min": 4,
      "max": 20,
      "step": 1,
      "default": 10,
      "label": "Maximum products to show"
    },
    {
      "type": "range",
      "id": "slides_desktop",
      "min": 2,
      "max": 4,
      "step": 1,
      "default": 3,
      "label": "Products visible (desktop)"
    },
    {
      "type": "checkbox",
      "id": "show_shop_all",
      "default": true,
      "label": "Show 'Shop All' button"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "range",
      "id": "products_width",
      "min": 30,
      "max": 70,
      "step": 5,
      "default": 55,
      "unit": "%",
      "label": "Products area width (desktop)"
    },
    {
      "type": "range",
      "id": "section_height",
      "min": 400,
      "max": 700,
      "step": 20,
      "default": 500,
      "unit": "px",
      "label": "Section height (desktop)"
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "shop_all_color",
      "label": "Shop All text color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "nav_color",
      "label": "Navigation arrows color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "mobile_slider_bg",
      "label": "Mobile slider background",
      "default": "#1a1a1a"
    },
    {
      "type": "header",
      "content": "Add to Cart Button"
    },
    {
      "type": "text",
      "id": "cart_button_text",
      "label": "Add to cart text",
      "default": "Add to Cart"
    },
    {
      "type": "text",
      "id": "sold_out_text",
      "label": "Sold out text",
      "default": "Sold Out"
    },
    {
      "type": "color",
      "id": "cart_button_bg",
      "label": "Add to cart button background",
      "default": "#000000"
    }
  ],
  "presets": [
    {
      "name": "Shop The Banner",
      "category": "Collection"
    }
  ]
}
{% endschema %}
