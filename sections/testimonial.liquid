{% comment %}
  Testimonial Section
  Displays customer testimonials in an autoplay slider.
  Each block: author name, star rating (1-5), description.
{% endcomment %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<section
  class="testimonial-section"
  style="
    background: {{ section.settings.background_color }};
    padding: {{ section.settings.padding_top }}px 0 {{ section.settings.padding_bottom }}px;
  "
>
  <div class="testimonial-container">
    {% if section.settings.heading != blank %}
      <h2 class="testimonial-heading" style="color: {{ section.settings.heading_color }};">
        {{ section.settings.heading }}
      </h2>
    {% endif %}

    {% if section.settings.subheading != blank %}
      <p class="testimonial-subheading" style="color: {{ section.settings.subheading_color }};">
        {{ section.settings.subheading }}
      </p>
    {% endif %}

    {% if section.blocks.size > 0 %}
      <div
        class="testimonial-slider"
        id="testimonial-slider"
        data-autoplay="{{ section.settings.autoplay }}"
        data-interval="{{ section.settings.autoplay_speed | times: 1000 }}"
      >
        <div class="testimonial-track" id="testimonial-track">
          {% for block in section.blocks %}
            <div
              class="testimonial-card"
              {{ block.shopify_attributes }}
              style="
                background: {{ section.settings.card_background }};
                border-color: {{ section.settings.card_border_color }};
              "
            >
              <div class="testimonial-stars" aria-label="{{ block.settings.rating }} out of 5 stars">
                {% for i in (1..5) %}
                  {% if i <= block.settings.rating %}
                    <svg
                      class="testimonial-star testimonial-star--filled"
                      width="18"
                      height="18"
                      viewBox="0 0 24 24"
                      fill="{{ section.settings.star_color }}"
                      stroke="none"
                    >
                      <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                    </svg>
                  {% else %}
                    <svg
                      class="testimonial-star testimonial-star--empty"
                      width="18"
                      height="18"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="{{ section.settings.star_color }}"
                      stroke-width="1.5"
                    >
                      <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                    </svg>
                  {% endif %}
                {% endfor %}
              </div>

              {% if block.settings.description != blank %}
                <p class="testimonial-description" style="color: {{ section.settings.text_color }};">
                  {{ block.settings.description }}
                </p>
              {% endif %}

              <div class="testimonial-author-wrap">
                {% if block.settings.author_image != blank %}
                  <img
                    class="testimonial-author-img"
                    src="{{ block.settings.author_image | image_url: width: 80, height: 80, crop: 'center' }}"
                    alt="{{ block.settings.author_name | escape }}"
                    width="40"
                    height="40"
                    loading="lazy"
                  >
                {% else %}
                  <div class="testimonial-author-initials" style="background: {{ section.settings.star_color }};">
                    {{ block.settings.author_name | slice: 0 | upcase }}
                  </div>
                {% endif %}

                <div class="testimonial-author-info">
                  {% if block.settings.author_name != blank %}
                    <span class="testimonial-author-name" style="color: {{ section.settings.author_name_color }};">
                      {{ block.settings.author_name }}
                    </span>
                  {% endif %}
                  {% if block.settings.author_title != blank %}
                    <span class="testimonial-author-title" style="color: {{ section.settings.text_color }};">
                      {{ block.settings.author_title }}
                    </span>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>

      <div class="testimonial-nav">
        <button class="testimonial-nav-btn testimonial-prev" aria-label="Previous testimonial">
          <i class="fa-solid fa-arrow-left"></i>
        </button>
        <button class="testimonial-nav-btn testimonial-next" aria-label="Next testimonial">
          <i class="fa-solid fa-arrow-right"></i>
        </button>
      </div>
    {% endif %}
  </div>
</section>

<style>
  .testimonial-section {
    width: 100%;
    overflow: hidden;
  }

  .testimonial-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 20px;
  }

  .testimonial-heading {
    text-align: center;
    font-size: clamp(24px, 4vw, 36px);
    font-weight: 400;
    margin: 0 0 8px;
    line-height: 1.3;
  }

  .testimonial-subheading {
    text-align: center;
    font-size: 16px;
    margin: 0 0 40px;
    opacity: 0.7;
  }

  .testimonial-slider {
    position: relative;
    overflow: hidden;
  }

  .testimonial-track {
    display: flex;
    gap: 24px;
    transition: transform 0.5s ease;
  }

  .testimonial-card {
    flex: 0 0 calc(33.333% - 16px);
    min-width: 280px;
    padding: 32px;
    border-radius: 12px;
    border: 1px solid;
    display: flex;
    flex-direction: column;
    gap: 16px;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .testimonial-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
  }

  .testimonial-stars {
    display: flex;
    gap: 3px;
  }

  .testimonial-description {
    font-size: 15px;
    line-height: 1.7;
    margin: 0;
    flex: 1;
  }

  .testimonial-author-wrap {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-top: 8px;
  }

  .testimonial-author-img {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
  }

  .testimonial-author-initials {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-size: 16px;
    font-weight: 600;
    flex-shrink: 0;
  }

  .testimonial-author-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .testimonial-author-name {
    font-size: 14px;
    font-weight: 600;
  }

  .testimonial-author-title {
    font-size: 13px;
    opacity: 0.6;
  }

  /* Navigation Buttons */
  .testimonial-nav {
    display: flex;
    justify-content: center;
    gap: 12px;
    margin-top: 32px;
  }

  .testimonial-nav-btn {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    border: 1px solid #ddd;
    background: transparent;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #333;
    font-size: 16px;
    transition: all 0.2s ease;
  }

  .testimonial-nav-btn:hover {
    background: #5c9bdd;
    border-color: #5c9bdd;
    color: #fff;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(92, 155, 221, 0.3);
  }

  /* Responsive */
  @media screen and (max-width: 992px) {
    .testimonial-track {
      gap: 16px;
    }
    .testimonial-card {
      flex: 0 0 calc(50% - 8px);
      min-width: 260px;
    }
  }

  @media screen and (max-width: 768px) {
    .testimonial-track {
      gap: 16px;
    }
    .testimonial-card {
      flex: 0 0 85%;
      min-width: 260px;
    }
    .testimonial-card:hover {
      transform: none;
    }
    .testimonial-subheading {
      margin-bottom: 24px;
    }
    .testimonial-nav {
      margin-top: 24px;
    }
  }

  @media screen and (max-width: 480px) {
    .testimonial-card {
      flex: 0 0 90%;
      padding: 24px;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .testimonial-card,
    .testimonial-nav-btn,
    .testimonial-track {
      transition: none;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    var slider = document.getElementById('testimonial-slider');
    if (!slider) return;

    var track = document.getElementById('testimonial-track');
    var cards = track.querySelectorAll('.testimonial-card');
    var container = slider.closest('.testimonial-container');
    var prevBtn = container.querySelector('.testimonial-prev');
    var nextBtn = container.querySelector('.testimonial-next');
    var autoplayEnabled = slider.dataset.autoplay === 'true';
    var interval = parseInt(slider.dataset.interval) || 4000;
    var currentOffset = 0;
    var autoplayTimer = null;

    if (cards.length === 0) return;

    function getVisibleCount() {
      var w = window.innerWidth;
      if (w <= 768) return 1;
      if (w <= 992) return 2;
      return 3;
    }

    function getCardWidth() {
      if (!cards[0]) return 0;
      var style = window.getComputedStyle(track);
      var gap = parseInt(style.gap) || 24;
      return cards[0].offsetWidth + gap;
    }

    function getMaxOffset() {
      var visible = getVisibleCount();
      return Math.max(0, cards.length - visible);
    }

    function updateSlider() {
      var cardWidth = getCardWidth();
      track.style.transform = 'translateX(-' + currentOffset * cardWidth + 'px)';
    }

    function goNext() {
      var max = getMaxOffset();
      if (max <= 0) return;
      currentOffset = currentOffset + 1 > max ? 0 : currentOffset + 1;
      updateSlider();
    }

    function goPrev() {
      var max = getMaxOffset();
      if (max <= 0) return;
      currentOffset = currentOffset - 1 < 0 ? max : currentOffset - 1;
      updateSlider();
    }

    function startAutoplay() {
      stopAutoplay();
      if (autoplayEnabled && getMaxOffset() > 0) {
        autoplayTimer = setInterval(goNext, interval);
      }
    }

    function stopAutoplay() {
      if (autoplayTimer) {
        clearInterval(autoplayTimer);
        autoplayTimer = null;
      }
    }

    if (prevBtn) {
      prevBtn.addEventListener('click', function () {
        goPrev();
        stopAutoplay();
        startAutoplay();
      });
    }

    if (nextBtn) {
      nextBtn.addEventListener('click', function () {
        goNext();
        stopAutoplay();
        startAutoplay();
      });
    }

    /* Pause on hover */
    slider.addEventListener('mouseenter', stopAutoplay);
    slider.addEventListener('mouseleave', startAutoplay);

    window.addEventListener('resize', function () {
      var max = getMaxOffset();
      if (currentOffset > max) currentOffset = max;
      updateSlider();
    });

    startAutoplay();
  });
</script>

{% schema %}
{
  "name": "Testimonials",
  "tag": "section",
  "class": "testimonial-section-wrapper",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "What Our Customers Say"
    },
    {
      "type": "text",
      "id": "subheading",
      "label": "Subheading",
      "default": "Real reviews from real people"
    },
    {
      "type": "header",
      "content": "Autoplay"
    },
    {
      "type": "checkbox",
      "id": "autoplay",
      "label": "Enable autoplay",
      "default": true
    },
    {
      "type": "range",
      "id": "autoplay_speed",
      "label": "Autoplay speed",
      "min": 2,
      "max": 10,
      "step": 1,
      "unit": "sec",
      "default": 4
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "heading_color",
      "label": "Heading color",
      "default": "#1a1a1a"
    },
    {
      "type": "color",
      "id": "subheading_color",
      "label": "Subheading color",
      "default": "#666666"
    },
    {
      "type": "color",
      "id": "card_background",
      "label": "Card background",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "card_border_color",
      "label": "Card border color",
      "default": "#e8e8e8"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text color",
      "default": "#444444"
    },
    {
      "type": "color",
      "id": "author_name_color",
      "label": "Author name color",
      "default": "#1a1a1a"
    },
    {
      "type": "color",
      "id": "star_color",
      "label": "Star color",
      "default": "#f5a623"
    },
    {
      "type": "header",
      "content": "Spacing"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Padding top",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 50
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Padding bottom",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 50
    }
  ],
  "blocks": [
    {
      "type": "testimonial",
      "name": "Testimonial",
      "settings": [
        {
          "type": "text",
          "id": "author_name",
          "label": "Author name",
          "default": "John Doe"
        },
        {
          "type": "text",
          "id": "author_title",
          "label": "Author title (optional)",
          "default": "Verified Buyer"
        },
        {
          "type": "image_picker",
          "id": "author_image",
          "label": "Author photo (optional)"
        },
        {
          "type": "range",
          "id": "rating",
          "label": "Star rating",
          "min": 1,
          "max": 5,
          "step": 1,
          "default": 5
        },
        {
          "type": "textarea",
          "id": "description",
          "label": "Review text",
          "default": "Amazing product! The quality exceeded my expectations. Will definitely be ordering again."
        }
      ]
    }
  ],
  "max_blocks": 12,
  "presets": [
    {
      "name": "Testimonials",
      "blocks": [
        {
          "type": "testimonial",
          "settings": {
            "author_name": "Sarah M.",
            "author_title": "Verified Buyer",
            "rating": 5,
            "description": "Absolutely love this product! The quality is outstanding and it arrived faster than expected. Highly recommend to everyone."
          }
        },
        {
          "type": "testimonial",
          "settings": {
            "author_name": "James R.",
            "author_title": "Verified Buyer",
            "rating": 5,
            "description": "Best purchase I've made this year. The attention to detail is incredible and customer service was top notch."
          }
        },
        {
          "type": "testimonial",
          "settings": {
            "author_name": "Priya K.",
            "author_title": "Verified Buyer",
            "rating": 4,
            "description": "Great value for money. The product looks exactly like the photos. Very happy with my purchase!"
          }
        }
      ]
    }
  ]
}
{% endschema %}
