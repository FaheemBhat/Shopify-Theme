{% comment %}
  Product Recommendations Section - Shopify Theme Section
  Uses Shopify's native Product Recommendations API to display related products
  Must be used on a product page. Product cards match the product-list section style.
{% endcomment %}

<section
  class="product-recs-section"
  data-section-id="{{ section.id }}"
  data-product-id="{{ product.id }}"
  data-limit="{{ section.settings.products_to_show }}"
  data-url="{{ routes.product_recommendations_url }}?section_id={{ section.id }}&product_id={{ product.id }}&limit={{ section.settings.products_to_show }}"
>
  <div class="product-recs-container">

    {%- comment -%} Section Header {%- endcomment -%}
    <div class="product-recs-header header-align-{{ section.settings.header_alignment }}">
      {% if section.settings.heading != blank %}
        <h2 class="product-recs-heading">{{ section.settings.heading }}</h2>
      {% endif %}
    </div>

    {%- comment -%} Products Grid â€” filled by Liquid on initial render & JS on re-fetch {%- endcomment -%}
    {% if recommendations.performed and recommendations.products_count > 0 %}
      <div class="product-recs-grid">
        {% for product in recommendations.products limit: section.settings.products_to_show %}
          <div class="rec-product-card" data-product-id="{{ product.id }}">

            {%- comment -%} Main Product Image {%- endcomment -%}
            <div class="rec-card-media">
              <a href="{{ product.url }}" class="rec-card-link">
                {% if product.featured_image != blank %}
                  <img
                    src="{{ product.featured_image | image_url: width: 600 }}"
                    srcset="{{ product.featured_image | image_url: width: 300 }} 300w, {{ product.featured_image | image_url: width: 450 }} 450w, {{ product.featured_image | image_url: width: 600 }} 600w"
                    sizes="(max-width: 768px) 50vw, 25vw"
                    alt="{{ product.featured_image.alt | default: product.title | escape }}"
                    {% if product.featured_image.presentation %}style="object-position: {{ product.featured_image.presentation.focal_point }}"{% endif %}
                    class="rec-card-image main-image"
                    loading="lazy"
                    width="300"
                    height="300"
                  >
                {% else %}
                  {{ 'product-1' | placeholder_svg_tag: 'rec-card-image placeholder-svg' }}
                {% endif %}
              </a>

              {%- comment -%} Sale Badge {%- endcomment -%}
              {% if product.compare_at_price > product.price %}
                <span class="rec-sale-badge">Sale</span>
              {% endif %}
            </div>

            {%- comment -%} Variant / Image Thumbnails {%- endcomment -%}
            {% if product.variants.size > 1 %}
              <div class="rec-thumbnails" data-thumbnail-type="variants">
                {% for variant in product.variants %}
                  <div class="rec-thumb {% if forloop.first %}active{% endif %}"
                       data-index="{{ forloop.index0 }}"
                       data-variant-id="{{ variant.id }}"
                       data-variant-price="{{ variant.price | money }}"
                       data-variant-compare-price="{% if variant.compare_at_price > variant.price %}{{ variant.compare_at_price | money }}{% endif %}"
                       data-variant-available="{{ variant.available }}"
                       data-image-url="{% if variant.featured_image %}{{ variant.featured_image | image_url: width: 600 }}{% else %}{{ product.featured_image | image_url: width: 600 }}{% endif %}"
                       data-image-alt="{{ variant.title | escape }}">
                    {% if variant.featured_image %}
                      <img
                        src="{{ variant.featured_image | image_url: width: 100 }}"
                        alt="{{ variant.title | escape }}"
                        loading="lazy"
                        width="50"
                        height="50"
                      >
                    {% else %}
                      <span class="rec-variant-label">{{ variant.title | truncate: 10 }}</span>
                    {% endif %}
                  </div>
                {% endfor %}
              </div>
            {% elsif product.images.size > 1 %}
              <div class="rec-thumbnails" data-thumbnail-type="images">
                {% for image in product.images %}
                  <div class="rec-thumb {% if forloop.first %}active{% endif %}"
                       data-index="{{ forloop.index0 }}"
                       data-image-url="{{ image | image_url: width: 600 }}"
                       data-image-alt="{{ image.alt | escape }}">
                    <img
                      src="{{ image | image_url: width: 100 }}"
                      alt="{{ image.alt | escape }}"
                      loading="lazy"
                      width="50"
                      height="50"
                    >
                  </div>
                {% endfor %}
              </div>
            {% endif %}

            {%- comment -%} Product Info {%- endcomment -%}
            <div class="rec-card-info">
              <a href="{{ product.url }}" class="rec-product-title">
                {{ product.title }}
              </a>

              <span class="rec-product-type">
                {{ product.type | upcase }}
              </span>

              <div class="rec-product-price">
                {% if product.compare_at_price > product.price %}
                  <span class="rec-price-sale">{{ product.price | money }}</span>
                  <span class="rec-price-compare">{{ product.compare_at_price | money }}</span>
                {% else %}
                  <span class="rec-price-regular">{{ product.price | money }}</span>
                {% endif %}
              </div>
            </div>

            {%- comment -%} Add to Cart {%- endcomment -%}
            <div class="rec-card-actions">
              {% form 'product', product, class: 'rec-product-form' %}
                <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
                <input type="hidden" name="quantity" value="1">

                <button
                  type="submit"
                  name="add"
                  class="rec-add-to-cart-btn"
                  {% unless product.available %}disabled{% endunless %}
                >
                  <svg class="rec-cart-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="9" cy="21" r="1"/>
                    <circle cx="20" cy="21" r="1"/>
                    <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
                  </svg>
                  {% if product.available %}
                    {{ section.settings.add_to_cart_text }}
                  {% else %}
                    SOLD OUT
                  {% endif %}
                </button>
              {% endform %}
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}

  </div>
</section>

<script>
(function() {
  function initRecCards(container) {
    var cards = container.querySelectorAll('.rec-product-card');
    cards.forEach(function (card) {
      var thumbnails      = card.querySelectorAll('.rec-thumb');
      var thumbContainer   = card.querySelector('.rec-thumbnails');
      var mainImage        = card.querySelector('.main-image');
      var priceContainer   = card.querySelector('.rec-product-price');
      var variantInput     = card.querySelector('input[name="id"]');
      var addToCartBtn     = card.querySelector('.rec-add-to-cart-btn');
      var isVariantType    = thumbContainer && thumbContainer.dataset.thumbnailType === 'variants';
      var currentIndex     = 0;

      if (thumbnails.length === 0) return;

      var svgMarkup = '<svg class="rec-cart-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>';

      function updateImage(index) {
        if (index >= thumbnails.length) currentIndex = 0;
        else if (index < 0) currentIndex = thumbnails.length - 1;
        else currentIndex = index;

        var active = thumbnails[currentIndex];
        thumbnails.forEach(function (t) { t.classList.remove('active'); });
        active.classList.add('active');

        if (mainImage && active.dataset.imageUrl) {
          mainImage.src = active.dataset.imageUrl;
          mainImage.removeAttribute('srcset');
          mainImage.alt = active.dataset.imageAlt || '';
        }

        if (isVariantType) {
          var vPrice   = active.dataset.variantPrice;
          var vCompare = active.dataset.variantComparePrice;
          var vId      = active.dataset.variantId;
          var vAvail   = active.dataset.variantAvailable === 'true';

          if (priceContainer && vPrice) {
            priceContainer.innerHTML = vCompare
              ? '<span class="rec-price-sale">' + vPrice + '</span><span class="rec-price-compare">' + vCompare + '</span>'
              : '<span class="rec-price-regular">' + vPrice + '</span>';
          }
          if (variantInput && vId) variantInput.value = vId;
          if (addToCartBtn) {
            addToCartBtn.disabled = !vAvail;
            addToCartBtn.innerHTML = svgMarkup + (vAvail ? ' {{ section.settings.add_to_cart_text }}' : ' SOLD OUT');
          }
        }

        if (thumbContainer && active) {
          thumbContainer.scrollLeft = active.offsetLeft - thumbContainer.offsetWidth / 2 + active.offsetWidth / 2;
        }
      }

      thumbnails.forEach(function (thumb, i) {
        thumb.addEventListener('click', function (e) {
          e.stopPropagation();
          updateImage(i);
        });
      });
    });
  }

  function initProductRecs(sectionEl) {
    if (!sectionEl) return;

    var productId = sectionEl.dataset.productId;
    if (!productId) return;

    var url = sectionEl.dataset.url;
    if (url) {
      fetch(url)
        .then(function (res) { return res.text(); })
        .then(function (html) {
          var parser = new DOMParser();
          var doc = parser.parseFromString(html, 'text/html');
          var freshSection = doc.querySelector('.product-recs-section');
          if (freshSection && freshSection.querySelector('.rec-product-card')) {
            sectionEl.innerHTML = freshSection.innerHTML;
            initRecCards(sectionEl);
          }
        })
        .catch(function (err) {
          console.error('Product recommendations fetch error:', err);
        });
    }

    initRecCards(sectionEl);
  }

  document.addEventListener('DOMContentLoaded', function () {
    initProductRecs(document.querySelector('.product-recs-section[data-section-id="{{ section.id }}"]'));
  });

  document.addEventListener('shopify:section:load', function(e) {
    var section = e.target.querySelector('.product-recs-section') || e.target;
    initProductRecs(section);
  });
})();
</script>

{% schema %}
{
  "name": "Product Recommendations",
  "tag": "section",
  "class": "product-recs-wrapper",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Recommended Products"
    },
    {
      "type": "select",
      "id": "header_alignment",
      "label": "Heading alignment",
      "options": [
        { "value": "left",   "label": "Left"   },
        { "value": "center", "label": "Center" },
        { "value": "right",  "label": "Right"  }
      ],
      "default": "center"
    },
    {
      "type": "range",
      "id": "heading_font_size",
      "label": "Heading font size",
      "min": 18,
      "max": 60,
      "step": 1,
      "unit": "px",
      "default": 36
    },
    {
      "type": "range",
      "id": "products_to_show",
      "min": 2,
      "max": 12,
      "step": 1,
      "default": 4,
      "label": "Products to show"
    },
    {
      "type": "range",
      "id": "products_per_row",
      "label": "Products per row (desktop)",
      "min": 2,
      "max": 6,
      "step": 1,
      "default": 4
    },
    {
      "type": "header",
      "content": "Add to Cart Button"
    },
    {
      "type": "text",
      "id": "add_to_cart_text",
      "label": "Button text",
      "default": "ADD TO CART"
    },
    {
      "type": "range",
      "id": "add_to_cart_font_size",
      "label": "Button font size",
      "min": 10,
      "max": 20,
      "step": 1,
      "unit": "px",
      "default": 13
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "heading_color",
      "label": "Heading color",
      "default": "#1a1a1a"
    },
    {
      "type": "color",
      "id": "card_background",
      "label": "Card background",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "price_color",
      "label": "Price color",
      "default": "#1a1a1a"
    },
    {
      "type": "color",
      "id": "sale_price_color",
      "label": "Sale price color",
      "default": "#1a1a1a"
    },
    {
      "type": "color",
      "id": "compare_price_color",
      "label": "Compare price color",
      "default": "#999999"
    },
    {
      "type": "color",
      "id": "product_type_color",
      "label": "Product type color",
      "default": "#ff6b35"
    },
    {
      "type": "color",
      "id": "button_background",
      "label": "Button background",
      "default": "#5c9bdd"
    },
    {
      "type": "color",
      "id": "button_text",
      "label": "Button text color",
      "default": "#ffffff"
    },
    {
      "type": "header",
      "content": "Spacing"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Section padding top",
      "default": 60
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Section padding bottom",
      "default": 60
    }
  ],
  "presets": [
    {
      "name": "Product Recommendations",
      "category": "Product"
    }
  ],
}
{% endschema %}

<style>
  /* ===== Product Recommendations Section ===== */
  .product-recs-section {
    --rec-heading-color: {{ section.settings.heading_color }};
    --rec-card-bg: {{ section.settings.card_background }};
    --rec-price-color: {{ section.settings.price_color }};
    --rec-sale-price-color: {{ section.settings.sale_price_color }};
    --rec-compare-price-color: {{ section.settings.compare_price_color }};
    --rec-type-color: {{ section.settings.product_type_color }};
    --rec-btn-bg: {{ section.settings.button_background }};
    --rec-btn-text: {{ section.settings.button_text }};

    padding-top: {{ section.settings.padding_top }}px;
    padding-bottom: {{ section.settings.padding_bottom }}px;
  }

  .product-recs-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 20px;
  }

  /* Header */
  .product-recs-header { margin-bottom: 40px; }
  .product-recs-header.header-align-left   { text-align: left;   }
  .product-recs-header.header-align-center { text-align: center; }
  .product-recs-header.header-align-right  { text-align: right;  }

  .product-recs-heading {
    font-size: {{ section.settings.heading_font_size }}px;
    font-weight: 700;
    color: var(--rec-heading-color);
    margin: 0;
    letter-spacing: -0.02em;
  }

  /* Grid */
  .product-recs-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 24px;
  }

  @media screen and (min-width: 769px) {
    .product-recs-grid {
      grid-template-columns: repeat({{ section.settings.products_per_row }}, 1fr);
    }
  }

  /* Card */
  .rec-product-card {
    background: var(--rec-card-bg);
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    display: flex;
    flex-direction: column;
  }

  .rec-product-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
  }

  /* Media */
  .rec-card-media {
    position: relative;
    aspect-ratio: 1;
    overflow: hidden;
    background: #f8f8f8;
  }

  .rec-card-link {
    display: block;
    width: 100%;
    height: 100%;
  }

  .rec-card-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s ease;
  }

  .rec-product-card:hover .rec-card-image {
    transform: scale(1.05);
  }

  .rec-card-media .placeholder-svg {
    width: 100%;
    height: 100%;
  }

  /* Sale Badge */
  .rec-sale-badge {
    position: absolute;
    top: 12px;
    left: 12px;
    background: #ff4757;
    color: white;
    font-size: 11px;
    font-weight: 700;
    padding: 4px 10px;
    border-radius: 20px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    z-index: 2;
  }

  /* Thumbnails */
  .rec-thumbnails {
    display: flex;
    gap: 8px;
    padding: 12px 16px;
    padding-right: calc(50% + 16px);
    background: white;
    justify-content: flex-start;
    overflow-x: auto;
    scrollbar-width: none;
  }

  .rec-thumbnails::-webkit-scrollbar { display: none; }

  .rec-thumb {
    flex-shrink: 0;
    width: 44px;
    height: 44px;
    border-radius: 8px;
    border: 2px solid transparent;
    background: #f5f5f5;
    cursor: pointer;
    padding: 4px;
    transition: all 0.2s ease;
    overflow: hidden;
  }

  .rec-thumb:hover {
    border-color: #ddd;
    transform: scale(1.05);
  }

  .rec-thumb.active {
    border-color: var(--rec-btn-bg);
    background: white;
  }

  .rec-thumb img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .rec-variant-label {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    font-size: 9px;
    font-weight: 600;
    text-align: center;
    color: var(--rec-heading-color);
    line-height: 1.1;
    word-break: break-word;
  }

  /* Product Info */
  .rec-card-info {
    padding: 16px;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .rec-product-title {
    font-size: 15px;
    font-weight: 600;
    color: var(--rec-heading-color);
    text-decoration: none;
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    transition: color 0.2s ease;
  }

  .rec-product-title:hover {
    color: var(--rec-type-color);
  }

  .rec-product-type {
    font-size: 11px;
    font-weight: 600;
    color: var(--rec-type-color);
    letter-spacing: 0.08em;
  }

  .rec-product-price {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 4px;
  }

  .rec-price-regular,
  .rec-price-sale {
    font-size: 18px;
    font-weight: 700;
    color: var(--rec-price-color);
  }

  .rec-price-compare {
    font-size: 14px;
    color: var(--rec-compare-price-color);
    text-decoration: line-through;
  }

  /* Add to Cart */
  .rec-card-actions {
    padding: 0 16px 16px;
  }

  .rec-product-form {
    width: 100%;
  }

  .rec-add-to-cart-btn {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 14px 20px;
    background: var(--rec-btn-bg);
    color: var(--rec-btn-text);
    border: none;
    border-radius: 10px;
    font-size: {{ section.settings.add_to_cart_font_size }}px;
    font-weight: 700;
    letter-spacing: 0.08em;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .rec-add-to-cart-btn:hover:not(:disabled) {
    background: var(--rec-type-color);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(92, 155, 221, 0.3);
  }

  .rec-add-to-cart-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .rec-add-to-cart-btn .rec-cart-icon {
    width: 18px;
    height: 18px;
  }

  /* ===== Responsive ===== */
  @media screen and (max-width: 768px) {
    .product-recs-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    .product-recs-heading { font-size: 28px; }

    .rec-thumb {
      width: 36px;
      height: 36px;
    }

    .rec-card-info { padding: 12px; }
    .rec-product-title { font-size: 14px; }

    .rec-price-regular,
    .rec-price-sale { font-size: 16px; }

    .rec-add-to-cart-btn { padding: 12px 16px; }
  }

  @media screen and (max-width: 480px) {
    .product-recs-container { padding: 0 12px; }
    .product-recs-grid { gap: 12px; }

    .rec-sale-badge {
      font-size: 10px;
      padding: 3px 8px;
      top: 8px;
      left: 8px;
    }

    .rec-thumbnails {
      padding: 8px 10px;
      gap: 6px;
    }

    .rec-thumb {
      width: 32px;
      height: 32px;
    }

    .rec-card-info { padding: 10px; }
    .rec-product-title { font-size: 13px; }
    .rec-product-type { font-size: 10px; }

    .rec-price-regular,
    .rec-price-sale { font-size: 15px; }

    .rec-price-compare { font-size: 12px; }

    .rec-card-actions { padding: 0 10px 10px; }

    .rec-add-to-cart-btn {
      padding: 10px 12px;
      font-size: 11px;
      border-radius: 8px;
    }

    .rec-add-to-cart-btn .rec-cart-icon {
      width: 14px;
      height: 14px;
    }
  }
</style>
