{% comment %}
  Popup section — Newsletter / promotional popup with image + form.
  Lives in overlay-group so it renders on every page as an overlay.
{% endcomment %}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer">

{% if section.settings.enable %}
  {% assign show_popup = true %}

  {% if section.settings.homepage_only %}
    {% unless request.path == '/' %}
      {% assign show_popup = false %}
    {% endunless %}
  {% endif %}

  {% if show_popup %}
    <div class="popup-overlay" id="popupOverlay"></div>

    <div class="popup" id="popupModal"
      role="dialog"
      aria-modal="true"
      aria-label="Promotional popup"
      data-section-id="{{ section.id }}"
      data-trigger="{{ section.settings.trigger }}"
      data-repeat="{{ section.settings.repeat }}"
      data-visitors-only="{{ section.settings.visitors_only }}"
      style="
        --popup-width: {{ section.settings.container_width }}px;
        --popup-text-align: {{ section.settings.text_alignment }};
        --popup-btn-bg: {{ section.settings.button_color }};
        --popup-btn-text: {{ section.settings.button_text_color }};
        --popup-btn-font-size: {{ section.settings.button_font_size }}px;
      "
    >
      <button class="popup__close" id="popupClose" aria-label="Close popup">
        <i class="fa-solid fa-xmark"></i>
      </button>

      <div class="popup__inner">
        {%- comment -%} Left: Image {%- endcomment -%}
        {% if section.settings.image %}
          <div class="popup__image">
            <img
              src="{{ section.settings.image | image_url: width: 800 }}"
              alt="{{ section.settings.heading | escape }}"
              width="800"
              height="800"
              loading="lazy"
            >
          </div>
        {% endif %}

        {%- comment -%} Right: Content + Form {%- endcomment -%}
        <div class="popup__content">
          {% if section.settings.heading != blank %}
            <h2 class="popup__heading">{{ section.settings.heading }}</h2>
          {% endif %}

          {% if section.settings.subtext != blank %}
            <p class="popup__subtext">{{ section.settings.subtext }}</p>
          {% endif %}

          <form class="popup__form" id="popupForm" method="post" action="/contact#contact_form" accept-charset="UTF-8">
            <input type="hidden" name="form_type" value="customer">
            <input type="hidden" name="utf8" value="✓">
            <input type="hidden" name="contact[tags]" value="newsletter,popup">

            {% if section.settings.show_name_field %}
              <input
                type="text"
                name="contact[first_name]"
                class="popup__input"
                placeholder="{{ section.settings.name_placeholder }}"
                autocomplete="given-name"
              >
            {% endif %}

            <input
              type="email"
              name="contact[email]"
              class="popup__input"
              placeholder="{{ section.settings.email_placeholder }}"
              required
              autocomplete="email"
            >

            <button type="submit" class="popup__submit">
              {{ section.settings.button_text }}
            </button>
          </form>

          {%- comment -%} Social icons {%- endcomment -%}
          {% if section.settings.show_social %}
            <div class="popup__social">
              {% if section.settings.social_facebook != blank %}
                <a href="{{ section.settings.social_facebook }}" class="popup__social-link" target="_blank" rel="noopener" aria-label="Facebook">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/></svg>
                </a>
              {% endif %}
              {% if section.settings.social_instagram != blank %}
                <a href="{{ section.settings.social_instagram }}" class="popup__social-link" target="_blank" rel="noopener" aria-label="Instagram">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"/><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"/></svg>
                </a>
              {% endif %}
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    {%- comment -%} Teaser button {%- endcomment -%}
    {% if section.settings.show_teaser %}
      <button class="popup-teaser" id="popupTeaser" aria-label="Open popup">
        {{ section.settings.teaser_text }}
      </button>
    {% endif %}
  {% endif %}
{% endif %}

{% stylesheet %}
  /* ===== OVERLAY ===== */
  .popup-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    backdrop-filter: blur(2px);
    z-index: 9990;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
  }
  .popup-overlay.popup--open {
    opacity: 1;
    visibility: visible;
  }

  /* ===== MODAL ===== */
  .popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.95);
    width: var(--popup-width);
    max-width: 94vw;
    max-height: 90vh;
    background: #fff;
    border-radius: 12px;
    z-index: 9991;
    overflow: hidden;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
  }
  .popup.popup--open {
    opacity: 1;
    visibility: visible;
    transform: translate(-50%, -50%) scale(1);
  }

  .popup__close {
    position: absolute;
    top: 12px;
    right: 12px;
    z-index: 2;
    background: none;
    border: none;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: #333;
    font-size: 22px;
    transition: color 0.2s;
  }
  .popup__close:hover {
    color: #000;
  }

  /* ===== INNER LAYOUT ===== */
  .popup__inner {
    display: grid;
    grid-template-columns: 1fr 1fr;
    min-height: 380px;
  }

  .popup__image {
    overflow: hidden;
  }
  .popup__image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .popup__content {
    padding: 40px 36px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    text-align: var(--popup-text-align);
  }

  .popup__heading {
    font-size: 24px;
    font-weight: 500;
    color: #1a1a1a;
    margin: 0 0 10px;
    line-height: 1.3;
  }

  .popup__subtext {
    font-size: 14px;
    color: #666;
    margin: 0 0 24px;
    line-height: 1.5;
  }

  /* ===== FORM ===== */
  .popup__form {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .popup__input {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid #ddd;
    border-radius: 30px;
    font-size: 14px;
    font-family: inherit;
    outline: none;
    transition: border-color 0.2s;
    box-sizing: border-box;
  }
  .popup__input:focus {
    border-color: #999;
  }

  .popup__submit {
    width: 100%;
    padding: 12px;
    background: var(--popup-btn-bg);
    color: var(--popup-btn-text);
    border: none;
    border-radius: 30px;
    font-size: var(--popup-btn-font-size);
    font-weight: 500;
    cursor: pointer;
    font-family: inherit;
    transition: opacity 0.2s;
  }
  .popup__submit:hover {
    opacity: 0.9;
  }

  /* ===== SOCIAL ===== */
  .popup__social {
    display: flex;
    gap: 12px;
    margin-top: 20px;
    justify-content: center;
  }
  .popup__social-link {
    width: 40px;
    height: 40px;
    border: 1px solid #ddd;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #1a1a1a;
    text-decoration: none;
    transition: background 0.2s;
  }
  .popup__social-link:hover {
    background: #f5f5f5;
  }

  /* ===== TEASER BUTTON ===== */
  .popup-teaser {
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 9989;
    padding: 12px 24px;
    background: var(--popup-btn-bg, #c28946);
    color: var(--popup-btn-text, #fff);
    border: none;
    border-radius: 30px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    font-family: inherit;
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    transition: opacity 0.2s;
    display: none;
  }
  .popup-teaser.popup-teaser--visible {
    display: block;
  }
  .popup-teaser:hover {
    opacity: 0.9;
  }

  /* ===== RESPONSIVE ===== */
  @media (max-width: 700px) {
    .popup__inner {
      grid-template-columns: 1fr;
    }
    .popup__image {
      max-height: 200px;
    }
    .popup__content {
      padding: 24px 20px;
    }
    .popup__heading {
      font-size: 20px;
    }
  }
{% endstylesheet %}

{% javascript %}
  (function() {
    var overlay = document.getElementById('popupOverlay');
    var modal = document.getElementById('popupModal');
    var closeBtn = document.getElementById('popupClose');
    var teaser = document.getElementById('popupTeaser');

    if (!modal) return;

    var trigger = modal.dataset.trigger || 'immediate';
    var repeat = modal.dataset.repeat || 'every_day';
    var visitorsOnly = modal.dataset.visitorsOnly === 'true';
    var storageKey = 'popup_' + modal.dataset.sectionId;

    function shouldShow() {
      if (visitorsOnly && window.__shopifyCustomer) return false;

      var lastShown = localStorage.getItem(storageKey);
      if (!lastShown) return true;

      var elapsed = Date.now() - parseInt(lastShown, 10);
      var day = 86400000;

      if (repeat === 'every_day') return elapsed > day;
      if (repeat === 'every_week') return elapsed > day * 7;
      if (repeat === 'every_month') return elapsed > day * 30;
      if (repeat === 'once') return false;

      return true;
    }

    function openPopup() {
      if (overlay) overlay.classList.add('popup--open');
      modal.classList.add('popup--open');
      document.body.style.overflow = 'hidden';
      localStorage.setItem(storageKey, Date.now().toString());
      if (teaser) teaser.classList.remove('popup-teaser--visible');
    }

    function closePopup() {
      if (overlay) overlay.classList.remove('popup--open');
      modal.classList.remove('popup--open');
      document.body.style.overflow = '';
      if (teaser) teaser.classList.add('popup-teaser--visible');
    }

    if (closeBtn) closeBtn.addEventListener('click', closePopup);
    if (overlay) overlay.addEventListener('click', closePopup);

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && modal.classList.contains('popup--open')) {
        closePopup();
      }
    });

    if (teaser) {
      teaser.addEventListener('click', openPopup);
    }

    if (shouldShow()) {
      if (trigger === 'immediate') {
        openPopup();
      } else if (trigger === 'delay_5') {
        setTimeout(openPopup, 5000);
      } else if (trigger === 'delay_10') {
        setTimeout(openPopup, 10000);
      } else if (trigger === 'scroll') {
        var scrollHandler = function() {
          var scrollPercent = (window.scrollY / (document.body.scrollHeight - window.innerHeight)) * 100;
          if (scrollPercent > 50) {
            openPopup();
            window.removeEventListener('scroll', scrollHandler);
          }
        };
        window.addEventListener('scroll', scrollHandler);
      }
    } else {
      if (teaser) teaser.classList.add('popup-teaser--visible');
    }

    /* Theme editor support */
    document.addEventListener('shopify:section:select', function(e) {
      if (e.detail.sectionId === modal.dataset.sectionId) openPopup();
    });
    document.addEventListener('shopify:section:deselect', function(e) {
      if (e.detail.sectionId === modal.dataset.sectionId) closePopup();
    });
  })();
{% endjavascript %}

{% schema %}
{
  "name": "Popup",
  "tag": "div",
  "limit": 1,
  "settings": [
    {
      "type": "header",
      "content": "General"
    },
    {
      "type": "checkbox",
      "id": "enable",
      "label": "Enable",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "homepage_only",
      "label": "Show on home page only",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "visitors_only",
      "label": "Show for visitors only",
      "default": false
    },
    {
      "type": "select",
      "id": "trigger",
      "label": "Trigger open",
      "options": [
        { "value": "immediate", "label": "Open immediately after page loaded" },
        { "value": "delay_5", "label": "Open after 5 seconds" },
        { "value": "delay_10", "label": "Open after 10 seconds" },
        { "value": "scroll", "label": "Open on scroll (50%)" }
      ],
      "default": "immediate",
      "info": "The last option is only working on the desktop. On mobile, the popup will appear after page loaded."
    },
    {
      "type": "select",
      "id": "repeat",
      "label": "Repeat open automatically",
      "options": [
        { "value": "every_day", "label": "Every day" },
        { "value": "every_week", "label": "Every week" },
        { "value": "every_month", "label": "Every month" },
        { "value": "once", "label": "Show once" }
      ],
      "default": "every_day",
      "info": "Time before popup appears again"
    },
    {
      "type": "select",
      "id": "text_alignment",
      "label": "Text alignment",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" }
      ],
      "default": "center"
    },
    {
      "type": "range",
      "id": "container_width",
      "label": "Container width",
      "min": 500,
      "max": 1200,
      "step": 10,
      "unit": "px",
      "default": 880
    },
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "image_picker",
      "id": "image",
      "label": "Image"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "This Diwali enjoy 20% OFF on all the products."
    },
    {
      "type": "textarea",
      "id": "subtext",
      "label": "Subtext",
      "default": "Sign up to know more about exciting offers."
    },
    {
      "type": "header",
      "content": "Form"
    },
    {
      "type": "checkbox",
      "id": "show_name_field",
      "label": "Show name field",
      "default": true
    },
    {
      "type": "text",
      "id": "name_placeholder",
      "label": "Name placeholder",
      "default": "First name"
    },
    {
      "type": "text",
      "id": "email_placeholder",
      "label": "Email placeholder",
      "default": "Enter your email"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button text",
      "default": "Sign Up"
    },
    {
      "type": "color",
      "id": "button_color",
      "label": "Button color",
      "default": "#c28946"
    },
    {
      "type": "color",
      "id": "button_text_color",
      "label": "Button text color",
      "default": "#ffffff"
    },
    {
      "type": "range",
      "id": "button_font_size",
      "label": "Button font size",
      "min": 12,
      "max": 22,
      "step": 1,
      "unit": "px",
      "default": 16
    },
    {
      "type": "header",
      "content": "Social links"
    },
    {
      "type": "checkbox",
      "id": "show_social",
      "label": "Show social icons",
      "default": true
    },
    {
      "type": "url",
      "id": "social_facebook",
      "label": "Facebook URL"
    },
    {
      "type": "url",
      "id": "social_instagram",
      "label": "Instagram URL"
    },
    {
      "type": "header",
      "content": "Teaser button"
    },
    {
      "type": "checkbox",
      "id": "show_teaser",
      "label": "Show teaser button",
      "default": false,
      "info": "Allows customers to open the popup manually."
    },
    {
      "type": "text",
      "id": "teaser_text",
      "label": "Teaser button text",
      "default": "Special Offer"
    }
  ]
}
{% endschema %}
