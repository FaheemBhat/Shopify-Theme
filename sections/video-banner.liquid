{% liquid
  assign layout = section.settings.layout
  assign video_type = section.settings.video_type
  assign video_url = section.settings.video_url
  assign iframe_code = section.settings.iframe_code
  assign poster = section.settings.poster_image
  assign mobile_poster = section.settings.mobile_poster_image
  assign banner_height = section.settings.banner_height
  assign overlay_opacity = section.settings.overlay_opacity
  assign content_position = section.settings.content_position
  assign heading = section.settings.heading
  assign subheading = section.settings.subheading
  assign button_text = section.settings.button_text
  assign button_link = section.settings.button_link
  assign play_button_size = section.settings.play_button_size
  assign autoplay = section.settings.autoplay
  assign loop_video = section.settings.loop_video
  assign muted = section.settings.muted
%}

<div class="video-banner color-{{ section.settings.color_scheme }} {% if layout == 'full-width' %}full-width{% else %}contained{% endif %}"
     data-section-id="{{ section.id }}"
     data-video-type="{{ video_type }}"
     data-autoplay="{{ autoplay }}"
     data-loop="{{ loop_video }}"
     data-muted="{{ muted }}"
     style="--banner-height: {{ banner_height }}px; --overlay-opacity: {{ overlay_opacity | divided_by: 100.0 }}; --play-size: {{ play_button_size }}px;">

  <div class="video-banner-inner">

    <!-- Poster / Thumbnail Layer -->
    <div class="video-poster-layer" data-poster-layer>
      {% if poster %}
        <picture>
          {% if mobile_poster %}
            <source media="(max-width: 768px)" srcset="{{ mobile_poster | image_url: width: 800 }}">
          {% endif %}
          <img
            src="{{ poster | image_url: width: 1920 }}"
            alt="{{ poster.alt | default: heading | default: 'Video banner' | escape }}"
            width="{{ poster.width }}"
            height="{{ poster.height }}"
            loading="lazy"
            class="video-poster-img">
        </picture>
      {% else %}
        <div class="video-poster-placeholder">
          {{ 'lifestyle-1' | placeholder_svg_tag: 'placeholder-svg' }}
        </div>
      {% endif %}
      <div class="video-overlay"></div>
    </div>

    <!-- Video Layer (hidden until play) -->
    <div class="video-player-layer" data-video-layer style="display: none;">
      {% if video_type == 'hosted' and video_url != blank %}
        <video
          class="video-element"
          data-video-el
          playsinline
          {% if loop_video %}loop{% endif %}
          {% if muted %}muted{% endif %}
          {% if autoplay %}autoplay muted{% endif %}
          {% if poster %}poster="{{ poster | image_url: width: 1920 }}"{% endif %}>
          <source src="{{ video_url }}" type="video/mp4">
        </video>
      {% elsif video_type == 'iframe' and iframe_code != blank %}
        <div class="video-iframe-wrap" data-iframe-wrap>
          {{ iframe_code }}
        </div>
      {% endif %}
    </div>

    <!-- Content Overlay -->
    <div class="video-content position-{{ content_position }}">
      <div class="video-content-inner">

        {% if heading != blank %}
          <h2 class="video-heading">{{ heading }}</h2>
        {% endif %}

        {% if subheading != blank %}
          <p class="video-subheading">{{ subheading }}</p>
        {% endif %}

        <!-- Play Button -->
        <button class="video-play-btn" data-play-btn aria-label="Play video" type="button">
          <span class="play-btn-circle">
            <svg class="play-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
              <path d="M8 5.14v13.72a1 1 0 001.5.86l11.04-6.86a1 1 0 000-1.72L9.5 4.28a1 1 0 00-1.5.86z"/>
            </svg>
          </span>
          {% if section.settings.play_label != blank %}
            <span class="play-btn-label">{{ section.settings.play_label }}</span>
          {% endif %}
        </button>

        {% if button_text != blank %}
          <a href="{{ button_link }}" class="video-cta">
            <span class="video-button">{{ button_text }}</span>
          </a>
        {% endif %}

      </div>
    </div>

    <!-- Close / Pause Button (visible when video is playing) -->
    <button class="video-close-btn" data-close-btn aria-label="Close video" type="button" style="display: none;">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
    </button>

  </div>
</div>

<style>
  /* ========================================
     VIDEO BANNER
     ======================================== */

  .video-banner {
    position: relative;
    width: 100%;
    margin: 0 auto;
    background-color: var(--color-background);
    color: var(--color-foreground);
  }

  .video-banner.full-width {
    max-width: 100%;
  }

  .video-banner.contained {
    max-width: 1400px;
    padding: 0 20px;
  }

  .video-banner-inner {
    position: relative;
    width: 100%;
    height: var(--banner-height);
    overflow: hidden;
    border-radius: 0;
  }

  .video-banner.contained .video-banner-inner {
    border-radius: 12px;
  }

  /* ---- Poster Layer ---- */
  .video-poster-layer {
    position: absolute;
    inset: 0;
    z-index: 1;
    transition: opacity 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }

  .video-poster-layer.hidden {
    opacity: 0;
    pointer-events: none;
  }

  .video-poster-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .video-poster-placeholder {
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .video-poster-placeholder .placeholder-svg {
    width: 40%;
    opacity: 0.15;
  }

  .video-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, var(--overlay-opacity));
    pointer-events: none;
  }

  /* ---- Video Layer ---- */
  .video-player-layer {
    position: absolute;
    inset: 0;
    z-index: 0;
  }

  .video-player-layer.active {
    z-index: 2;
  }

  .video-element {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .video-iframe-wrap {
    width: 100%;
    height: 100%;
  }

  .video-iframe-wrap iframe {
    width: 100%;
    height: 100%;
    border: 0;
    object-fit: cover;
  }

  /* ---- Content Overlay ---- */
  .video-content {
    position: absolute;
    inset: 0;
    z-index: 3;
    display: flex;
    padding: 48px;
    transition: opacity 0.4s ease;
  }

  .video-content.fade-out {
    opacity: 0;
    pointer-events: none;
  }

  .video-content-inner {
    display: flex;
    flex-direction: column;
    gap: 0;
    max-width: 640px;
  }

  /* Content Positions */
  .position-center {
    align-items: center;
    justify-content: center;
    text-align: center;
  }

  .position-center .video-content-inner {
    align-items: center;
  }

  .position-bottom-left {
    align-items: flex-start;
    justify-content: flex-end;
    text-align: left;
  }

  .position-bottom-left .video-content-inner {
    align-items: flex-start;
  }

  .position-bottom-center {
    align-items: center;
    justify-content: flex-end;
    text-align: center;
  }

  .position-bottom-center .video-content-inner {
    align-items: center;
  }

  .position-top-left {
    align-items: flex-start;
    justify-content: flex-start;
    text-align: left;
  }

  .position-top-left .video-content-inner {
    align-items: flex-start;
  }

  .position-center-left {
    align-items: flex-start;
    justify-content: center;
    text-align: left;
  }

  .position-center-left .video-content-inner {
    align-items: flex-start;
  }

  /* ---- Typography ---- */
  .video-heading {
    font-size: clamp(28px, 5vw, 56px);
    font-weight: 700;
    line-height: 1.1;
    letter-spacing: -0.02em;
    margin: 0 0 16px;
    color: #fff;
    text-shadow: 0 2px 16px rgba(0, 0, 0, 0.3);
  }

  .video-subheading {
    font-size: clamp(14px, 1.5vw, 18px);
    line-height: 1.6;
    margin: 0 0 36px;
    color: rgba(255, 255, 255, 0.8);
    max-width: 480px;
  }

  /* ---- Play Button ---- */
  .video-play-btn {
    display: inline-flex;
    align-items: center;
    gap: 16px;
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
    margin-bottom: 28px;
    outline: none;
  }

  .play-btn-circle {
    display: flex;
    align-items: center;
    justify-content: center;
    width: var(--play-size);
    height: var(--play-size);
    border-radius: 50%;
    background: #fff;
    color: #111;
    position: relative;
    transition: transform 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94),
                box-shadow 0.35s ease;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
  }

  .play-btn-circle::before {
    content: '';
    position: absolute;
    inset: -6px;
    border-radius: 50%;
    border: 2px solid rgba(255, 255, 255, 0.3);
    transition: transform 0.35s ease, opacity 0.35s ease;
  }

  .video-play-btn:hover .play-btn-circle {
    transform: scale(1.08);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.35);
  }

  .video-play-btn:hover .play-btn-circle::before {
    transform: scale(1.15);
    opacity: 0;
  }

  .play-icon {
    width: 28%;
    height: 28%;
    margin-left: 3px;
  }

  .play-btn-label {
    font-size: 13px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: #fff;
    text-shadow: 0 1px 8px rgba(0, 0, 0, 0.4);
  }

  /* Pulse ring animation on idle */
  .play-btn-circle::after {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 50%;
    border: 2px solid rgba(255, 255, 255, 0.5);
    animation: pulse-ring 2.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) infinite;
  }

  @keyframes pulse-ring {
    0% { transform: scale(1); opacity: 0.6; }
    70% { transform: scale(1.35); opacity: 0; }
    100% { transform: scale(1.35); opacity: 0; }
  }

  /* ---- CTA Button (matches collection-grid style) ---- */
  .video-cta {
    display: inline-block;
    text-decoration: none;
  }

  .video-button {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 2px;
    border-bottom: 2px solid #fff;
    padding-bottom: 6px;
    color: #fff;
    transition: opacity 0.3s ease;
  }

  .video-button:hover {
    opacity: 0.7;
  }

  /* ---- Close Button ---- */
  .video-close-btn {
    position: absolute;
    top: 20px;
    right: 20px;
    z-index: 5;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.95);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #111;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
  }

  .video-close-btn:hover {
    transform: scale(1.08);
    box-shadow: 0 6px 24px rgba(0, 0, 0, 0.2);
  }

  /* ========================================
     RESPONSIVE
     ======================================== */

  @media screen and (max-width: 990px) {
    .video-banner-inner {
      height: calc(var(--banner-height) * 0.7);
    }

    .video-content {
      padding: 32px;
    }
  }

  @media screen and (max-width: 480px) {
    .video-banner-inner {
      height: calc(var(--banner-height) * 0.55);
    }

    .video-banner.contained .video-banner-inner {
      border-radius: 8px;
    }

    .video-content {
      padding: 24px;
    }

    .video-heading {
      font-size: 24px;
    }

    .video-subheading {
      font-size: 13px;
      margin-bottom: 24px;
    }

    .play-btn-label {
      font-size: 11px;
      letter-spacing: 1.5px;
    }

    .video-close-btn {
      width: 36px;
      height: 36px;
      top: 12px;
      right: 12px;
    }

    .video-button {
      font-size: 11px;
    }
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  var section = document.querySelector('[data-section-id="{{ section.id }}"]');
  if (!section) return;

  var playBtn = section.querySelector('[data-play-btn]');
  var closeBtn = section.querySelector('[data-close-btn]');
  var posterLayer = section.querySelector('[data-poster-layer]');
  var videoLayer = section.querySelector('[data-video-layer]');
  var videoEl = section.querySelector('[data-video-el]');
  var iframeWrap = section.querySelector('[data-iframe-wrap]');
  var content = section.querySelector('.video-content');
  var videoType = section.getAttribute('data-video-type');
  var shouldAutoplay = section.getAttribute('data-autoplay') === 'true';
  var isPlaying = false;

  if (shouldAutoplay && videoEl) {
    startVideo();
  }

  if (playBtn) {
    playBtn.addEventListener('click', function() {
      if (!isPlaying) {
        startVideo();
      }
    });
  }

  if (closeBtn) {
    closeBtn.addEventListener('click', function() {
      stopVideo();
    });
  }

  function startVideo() {
    if (!videoLayer) return;

    videoLayer.style.display = 'block';

    requestAnimationFrame(function() {
      videoLayer.classList.add('active');
      posterLayer.classList.add('hidden');
      content.classList.add('fade-out');
      closeBtn.style.display = 'flex';
      isPlaying = true;

      if (videoType === 'hosted' && videoEl) {
        videoEl.play().catch(function() {});
      }

      if (videoType === 'iframe' && iframeWrap) {
        var iframe = iframeWrap.querySelector('iframe');
        if (iframe) {
          var src = iframe.getAttribute('src') || iframe.getAttribute('data-src');
          if (src) {
            var separator = src.indexOf('?') > -1 ? '&' : '?';
            if (src.indexOf('autoplay=') === -1) {
              iframe.setAttribute('src', src + separator + 'autoplay=1');
            }
          }
        }
      }
    });
  }

  function stopVideo() {
    posterLayer.classList.remove('hidden');
    content.classList.remove('fade-out');
    closeBtn.style.display = 'none';
    isPlaying = false;

    if (videoType === 'hosted' && videoEl) {
      videoEl.pause();
      videoEl.currentTime = 0;
    }

    if (videoType === 'iframe' && iframeWrap) {
      var iframe = iframeWrap.querySelector('iframe');
      if (iframe) {
        var src = iframe.getAttribute('src');
        iframe.setAttribute('src', '');
        setTimeout(function() {
          iframe.setAttribute('src', src.replace('&autoplay=1', '').replace('?autoplay=1', ''));
        }, 100);
      }
    }

    setTimeout(function() {
      videoLayer.classList.remove('active');
      videoLayer.style.display = 'none';
    }, 600);
  }

  if (videoEl) {
    videoEl.addEventListener('ended', function() {
      var shouldLoop = section.getAttribute('data-loop') === 'true';
      if (!shouldLoop) {
        stopVideo();
      }
    });
  }
});
</script>

{% schema %}
{
  "name": "Video Banner",
  "tag": "section",
  "class": "section-video-banner",
  "settings": [
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "select",
      "id": "layout",
      "label": "Section width",
      "options": [
        { "value": "full-width", "label": "Full width" },
        { "value": "contained", "label": "Container (1400px max)" }
      ],
      "default": "full-width"
    },
    {
      "type": "range",
      "id": "banner_height",
      "label": "Banner height (desktop)",
      "min": 300,
      "max": 900,
      "step": 50,
      "unit": "px",
      "default": 650
    },
    {
      "type": "select",
      "id": "content_position",
      "label": "Content position",
      "options": [
        { "value": "center", "label": "Center" },
        { "value": "center-left", "label": "Center left" },
        { "value": "bottom-center", "label": "Bottom center" },
        { "value": "bottom-left", "label": "Bottom left" },
        { "value": "top-left", "label": "Top left" }
      ],
      "default": "center"
    },
    {
      "type": "header",
      "content": "Video source"
    },
    {
      "type": "select",
      "id": "video_type",
      "label": "Video type",
      "options": [
        { "value": "hosted", "label": "Hosted video (MP4 URL)" },
        { "value": "iframe", "label": "Embed / iFrame" }
      ],
      "default": "hosted",
      "info": "Choose 'Hosted video' for a direct MP4 link, or 'Embed' to paste a YouTube/Vimeo iframe"
    },
    {
      "type": "text",
      "id": "video_url",
      "label": "Video URL (MP4)",
      "info": "Paste a direct link to an MP4 video file. Used when type is 'Hosted video'."
    },
    {
      "type": "html",
      "id": "iframe_code",
      "label": "Embed / iFrame code",
      "info": "Paste the full iframe embed code from YouTube, Vimeo, etc. Used when type is 'Embed'."
    },
    {
      "type": "header",
      "content": "Poster image"
    },
    {
      "type": "image_picker",
      "id": "poster_image",
      "label": "Desktop poster image",
      "info": "Shown before the video plays. Recommended: 1920x1080px"
    },
    {
      "type": "image_picker",
      "id": "mobile_poster_image",
      "label": "Mobile poster image (optional)",
      "info": "Recommended: 800x600px"
    },
    {
      "type": "range",
      "id": "overlay_opacity",
      "label": "Overlay darkness",
      "min": 0,
      "max": 80,
      "step": 5,
      "unit": "%",
      "default": 30,
      "info": "Darkens the poster image for better text readability"
    },
    {
      "type": "header",
      "content": "Playback"
    },
    {
      "type": "checkbox",
      "id": "autoplay",
      "label": "Autoplay (muted)",
      "default": false,
      "info": "Video will autoplay muted. Only works with hosted video."
    },
    {
      "type": "checkbox",
      "id": "loop_video",
      "label": "Loop video",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "muted",
      "label": "Muted by default",
      "default": false,
      "info": "Autoplay always requires muted audio"
    },
    {
      "type": "header",
      "content": "Play button"
    },
    {
      "type": "range",
      "id": "play_button_size",
      "label": "Play button size",
      "min": 48,
      "max": 96,
      "step": 8,
      "unit": "px",
      "default": 72
    },
    {
      "type": "text",
      "id": "play_label",
      "label": "Play button label",
      "info": "Optional text next to the play button (e.g. 'Watch Film')"
    },
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading"
    },
    {
      "type": "textarea",
      "id": "subheading",
      "label": "Subheading"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button text",
      "info": "Optional secondary link below the play button"
    },
    {
      "type": "url",
      "id": "button_link",
      "label": "Button link"
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "scheme-1"
    }
  ],
  "presets": [
    {
      "name": "Video Banner"
    }
  ]
}
{% endschema %}
